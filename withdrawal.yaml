apiVersion: v1
kind: ServiceAccount
metadata:
  name: akash-provider-withdrawal-sa
  namespace: cryptoandcoffee
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: akash-services
  name: akash-provider-withdrawal-role
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["pods/exec"]
  verbs: ["create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: akash-provider-withdrawal-rolebinding
  namespace: akash-services
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: akash-provider-withdrawal-role
subjects:
- kind: ServiceAccount
  name: akash-provider-withdrawal-sa
  namespace: cryptoandcoffee
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: akash-provider-withdrawal
  namespace: cryptoandcoffee
spec:
  replicas: 1
  selector:
    matchLabels:
      app: akash-provider-withdrawal
  template:
    metadata:
      labels:
        app: akash-provider-withdrawal
    spec:
      serviceAccountName: akash-provider-withdrawal-sa
      containers:
      - name: akash-provider-withdrawal
        image: cryptoandcoffee/akash-provider-withdrawal
        command: ["/bin/bash", "-c"]
        args:
          - curl -sLO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl" &&
            chmod +x ./kubectl &&
            mv ./kubectl /usr/local/bin/kubectl &&
            kubectl exec -n akash-services akash-provider-0 -- cat /boot-keys/key.txt > /app/key.pem &&
            export PASS=$(kubectl exec -n akash-services akash-provider-0 -- cat /boot-keys/key-pass.txt) &&
            export PROVIDER=$(kubectl get pod akash-provider-0 -n akash-services -o jsonpath='{.spec.containers[0].env[?(@.name=="AKASH_CLUSTER_PUBLIC_HOSTNAME")].value}') &&
            /app/start.sh;
        env:
        - name: ONLY_NEGATIVE_BALANCES
          value: "true"
        - name: FEE
          value: "4000"
        - name: NODE
          value: "https://akash-rpc.global.ssl.fastly.net:443"
        - name: MODE
          value: "block"
        - name: DELAY
          value: "15"
